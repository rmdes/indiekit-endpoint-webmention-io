{% extends "document.njk" %}

{% block content %}
<style>
  .bl-section {
    background: var(--color-offset, #f5f5f5);
    border-radius: var(--border-radius-small, 0.5rem);
    padding: var(--space-m, 1.5rem);
    margin-block-end: var(--space-m, 1.5rem);
  }

  .bl-section h2 {
    font: var(--font-heading, bold 1.25rem/1.4 sans-serif);
    margin-block-end: var(--space-xs, 0.5rem);
  }

  .bl-section__desc {
    color: var(--color-on-offset, #666);
    font: var(--font-body, 0.875rem/1.5 sans-serif);
    margin-block-end: var(--space-s, 0.75rem);
  }

  .bl-form {
    display: flex;
    gap: var(--space-xs, 0.5rem);
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .bl-form .field {
    flex: 1;
    min-width: 200px;
  }

  .bl-form .field__label {
    display: block;
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
    font-weight: 600;
    margin-block-end: 0.25rem;
  }

  .bl-form .field__input {
    width: 100%;
    padding: var(--space-2xs, 0.375rem) var(--space-xs, 0.5rem);
    border: 1px solid var(--color-outline-variant, #ccc);
    border-radius: var(--border-radius-small, 0.25rem);
    font: var(--font-body, 0.875rem/1.5 sans-serif);
  }

  .bl-table {
    width: 100%;
    border-collapse: collapse;
    font: var(--font-body, 0.875rem/1.5 sans-serif);
  }

  .bl-table th {
    text-align: left;
    font-weight: 600;
    padding: var(--space-xs, 0.5rem);
    border-block-end: 2px solid var(--color-outline-variant, #ddd);
  }

  .bl-table td {
    padding: var(--space-xs, 0.5rem);
    border-block-end: 1px solid var(--color-outline-variant, #eee);
    vertical-align: middle;
  }

  .bl-badge {
    display: inline-block;
    font: var(--font-caption, 0.6875rem/1.4 sans-serif);
    padding: 0.125rem 0.375rem;
    border-radius: var(--border-radius-small, 0.25rem);
    background: var(--color-offset, #e9ecef);
  }

  .bl-badge--privacy {
    background: var(--color-error-container, #f8d7da);
    color: var(--color-error, #dc3545);
  }

  .bl-badge--spam {
    background: var(--color-warning-container, #fff3cd);
    color: var(--color-warning, #856404);
  }

  .bl-empty {
    color: var(--color-on-offset, #666);
    text-align: center;
    padding: var(--space-m, 1rem);
  }

  .bl-success {
    background: var(--color-success-container, #d4edda);
    border: 1px solid var(--color-success, #28a745);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-end: var(--space-m, 1rem);
  }

  .bl-back {
    margin-block-end: var(--space-m, 1rem);
  }
</style>

<div class="bl-back">
  <a href="{{ wmEndpoint }}">&larr; {{ __("webmention-io.title") }}</a>
</div>

{# Flash messages #}
{% if request.query.unblocked %}
<div class="bl-success">
  {{ __("webmention-io.blocklist.unblocked") }} â€” {{ request.query.unhidden or 0 }} {{ __("webmention-io.blocklist.unhidden") }}
</div>
{% endif %}
{% if request.query.removed %}
<div class="bl-success">
  {{ request.query.count or 0 }} {{ __("webmention-io.blocklist.removed") }}
</div>
{% endif %}

{# Add to blocklist #}
<section class="bl-section">
  <h2>{{ __("webmention-io.blocklist.add") }}</h2>
  <p class="bl-section__desc">{{ __("webmention-io.blocklist.description") }}</p>

  <form method="post" action="{{ wmEndpoint }}/block" class="bl-form">
    <div class="field">
      <label class="field__label">{{ __("webmention-io.blocklist.domainLabel") }}</label>
      <input type="text" name="domain" class="field__input" placeholder="{{ __("webmention-io.blocklist.domainPlaceholder") }}" required>
    </div>
    <button type="submit" class="button button--primary">{{ __("webmention-io.blocklist.blockButton") }}</button>
  </form>
</section>

{# Privacy removal #}
<section class="bl-section">
  <h2>{{ __("webmention-io.blocklist.privacy.title") }}</h2>
  <p class="bl-section__desc">{{ __("webmention-io.blocklist.privacy.description") }}</p>

  <form method="post" action="{{ wmEndpoint }}/privacy-remove" class="bl-form"
        onsubmit="return confirm('This will PERMANENTLY DELETE all webmentions from this domain and block it. This cannot be undone. Continue?')">
    <div class="field">
      <label class="field__label">{{ __("webmention-io.blocklist.privacy.domainLabel") }}</label>
      <input type="text" name="domain" class="field__input" placeholder="{{ __("webmention-io.blocklist.domainPlaceholder") }}" required>
    </div>
    <button type="submit" class="button button--primary">{{ __("webmention-io.blocklist.privacy.removeButton") }}</button>
  </form>
</section>

{# Blocklist table #}
<section class="bl-section">
  <h2>{{ __("webmention-io.blocklist.title") }} ({{ entries.length }})</h2>

  {% if entries.length > 0 %}
  <table class="bl-table">
    <thead>
      <tr>
        <th>{{ __("webmention-io.blocklist.domainLabel") }}</th>
        <th>{{ __("webmention-io.blocklist.reasonLabel") }}</th>
        <th>{{ __("webmention-io.blocklist.mentionsHidden") }}</th>
        <th>{{ __("webmention-io.blocklist.blockedAt") }}</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for entry in entries %}
      <tr>
        <td><strong>{{ entry.domain }}</strong></td>
        <td>
          <span class="bl-badge {% if entry.reason == 'privacy' %}bl-badge--privacy{% elif entry.reason == 'spam' %}bl-badge--spam{% endif %}">
            {{ entry.reason }}
          </span>
        </td>
        <td>{{ entry.mentionsHidden or 0 }}</td>
        <td>{{ entry.blockedAt | date("PPp") }}</td>
        <td>
          <form method="post" action="{{ wmEndpoint }}/blocklist/{{ entry.domain | urlencode }}/delete" style="display:inline">
            <button type="submit" class="button button--small button--secondary"
                    onclick="return confirm('Unblock {{ entry.domain }}? Mentions hidden by this block will be restored.')">
              {{ __("webmention-io.blocklist.unblock") }}
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="bl-empty">{{ __("webmention-io.blocklist.empty") }}</p>
  {% endif %}
</section>
{% endblock %}
