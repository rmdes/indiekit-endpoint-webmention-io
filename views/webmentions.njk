{% extends "document.njk" %}

{% block content %}
<style>
  .wm-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: var(--space-s, 0.75rem);
    margin-block-end: var(--space-m, 1.5rem);
  }

  .wm-stats {
    display: flex;
    gap: var(--space-m, 1rem);
    font: var(--font-body, 0.875rem/1.5 sans-serif);
    color: var(--color-on-offset, #666);
  }

  .wm-stats__item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .wm-stats__count {
    font-weight: 700;
    color: var(--color-on-surface, inherit);
  }

  .wm-actions-bar {
    display: flex;
    gap: var(--space-xs, 0.5rem);
    flex-wrap: wrap;
    align-items: center;
  }

  .wm-sync-info {
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
    color: var(--color-on-offset, #666);
  }

  .wm-filters {
    display: flex;
    gap: var(--space-m, 1rem);
    margin-block-end: var(--space-m, 1rem);
    flex-wrap: wrap;
    font: var(--font-body, 0.875rem/1.5 sans-serif);
  }

  .wm-filters a {
    text-decoration: none;
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius-small, 0.25rem);
    color: var(--color-on-offset, #666);
  }

  .wm-filters a.active {
    background: var(--color-primary, #0066cc);
    color: var(--color-on-primary, #fff);
  }

  .wm-mention-wrapper {
    margin-block-end: var(--space-xs, 0.5rem);
    position: relative;
  }

  .wm-mention-wrapper--hidden {
    opacity: 0.5;
  }

  .wm-mention-actions {
    display: flex;
    gap: var(--space-2xs, 0.25rem);
    margin-block-start: var(--space-2xs, 0.25rem);
    padding-inline-start: 3.5rem;
  }

  .wm-mention-badge {
    display: inline-block;
    font: var(--font-caption, 0.6875rem/1.4 sans-serif);
    padding: 0.125rem 0.375rem;
    border-radius: var(--border-radius-small, 0.25rem);
    background: var(--color-warning-container, #fff3cd);
    color: var(--color-warning, #856404);
  }

  .wm-success {
    background: var(--color-success-container, #d4edda);
    border: 1px solid var(--color-success, #28a745);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-end: var(--space-m, 1rem);
  }

  .wm-error {
    background: var(--color-error-container, #f8d7da);
    border: 1px solid var(--color-error, #dc3545);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-s, 0.75rem);
    margin-block-end: var(--space-m, 1rem);
  }
</style>

{# Flash messages #}
{% if request.query.synced %}
<div class="wm-success">
  {{ __("webmention-io.sync.synced") }} â€” {{ request.query.added or 0 }} {{ __("webmention-io.sync.added") }}
</div>
{% endif %}
{% if request.query.hidden %}
<div class="wm-success">Webmention hidden.</div>
{% endif %}
{% if request.query.unhidden %}
<div class="wm-success">Webmention restored.</div>
{% endif %}
{% if request.query.blocked %}
<div class="wm-success">{{ __("webmention-io.blocklist.blocked") }}: {{ request.query.domain }}</div>
{% endif %}
{% if request.query.error %}
<div class="wm-error">Error: {{ request.query.error }}</div>
{% endif %}

{# Header with stats and sync controls #}
<div class="wm-header">
  <div class="wm-stats">
    <span class="wm-stats__item">
      <span class="wm-stats__count">{{ counts.visible }}</span> {{ __("webmention-io.counts.visible") }}
    </span>
    <span class="wm-stats__item">
      <span class="wm-stats__count">{{ counts.hidden }}</span> {{ __("webmention-io.counts.hidden") }}
    </span>
    <span class="wm-stats__item">
      <span class="wm-stats__count">{{ counts.total }}</span> {{ __("webmention-io.counts.total") }}
    </span>
  </div>

  <div class="wm-actions-bar">
    <span class="wm-sync-info">
      {% if syncState.lastSync %}
        {{ __("webmention-io.sync.lastSync") }}: {{ syncState.lastSync }}
      {% else %}
        {{ __("webmention-io.sync.never") }}
      {% endif %}
    </span>
    <form method="post" action="{{ wmEndpoint }}/sync" style="display:inline">
      <button type="submit" class="button button--small">{{ __("webmention-io.sync.now") }}</button>
    </form>
    <form method="post" action="{{ wmEndpoint }}/sync/full" style="display:inline"
          onsubmit="return confirm('This will clear all cached webmentions and re-fetch from webmention.io. Continue?')">
      <button type="submit" class="button button--small button--secondary">{{ __("webmention-io.sync.full") }}</button>
    </form>
    <a href="{{ wmEndpoint }}/blocklist" class="button button--small button--secondary">{{ __("webmention-io.blocklist.title") }}</a>
  </div>
</div>

{# Filters #}
<div class="wm-filters">
  <div>
    {{ __("webmention-io.filter.show") }}:
    <a href="{{ wmEndpoint }}?filter=all&type={{ typeFilter }}" class="{% if filter == 'all' %}active{% endif %}">{{ __("webmention-io.filter.all") }}</a>
    <a href="{{ wmEndpoint }}?filter=visible&type={{ typeFilter }}" class="{% if filter == 'visible' %}active{% endif %}">{{ __("webmention-io.filter.visible") }}</a>
    <a href="{{ wmEndpoint }}?filter=hidden&type={{ typeFilter }}" class="{% if filter == 'hidden' %}active{% endif %}">{{ __("webmention-io.filter.hidden") }}</a>
  </div>
  <div>
    {{ __("webmention-io.filter.type") }}:
    <a href="{{ wmEndpoint }}?filter={{ filter }}&type=all" class="{% if typeFilter == 'all' %}active{% endif %}">{{ __("webmention-io.filter.all") }}</a>
    <a href="{{ wmEndpoint }}?filter={{ filter }}&type=like-of" class="{% if typeFilter == 'like-of' %}active{% endif %}">{{ __("webmention-io.filter.likes") }}</a>
    <a href="{{ wmEndpoint }}?filter={{ filter }}&type=in-reply-to" class="{% if typeFilter == 'in-reply-to' %}active{% endif %}">{{ __("webmention-io.filter.replies") }}</a>
    <a href="{{ wmEndpoint }}?filter={{ filter }}&type=repost-of" class="{% if typeFilter == 'repost-of' %}active{% endif %}">{{ __("webmention-io.filter.reposts") }}</a>
    <a href="{{ wmEndpoint }}?filter={{ filter }}&type=mention-of" class="{% if typeFilter == 'mention-of' %}active{% endif %}">{{ __("webmention-io.filter.mentions") }}</a>
  </div>
</div>

{# Webmention list #}
{%- if webmentions and webmentions.length > 0 %}
  {% for item in webmentions %}
  <div class="wm-mention-wrapper {% if item.hidden %}wm-mention-wrapper--hidden{% endif %}">
    {{ mention({
      user: {
        avatar: item.user.avatar,
        meta: __("webmention-io.mention." + item["wm-property"], item["wm-target"]) | urlize,
        name: item.user.name
      },
      mention: {
        title: item.title,
        icon: item.icon,
        description: item.description if item.description and item.description.html,
        permalink: item.url,
        published: item.published
      }
    }) | indent(4) }}

    <div class="wm-mention-actions">
      {% if item.hidden %}
        <span class="wm-mention-badge">{{ __("webmention-io.actions.hidden") }} ({{ item.hiddenReason or "manual" }})</span>
        <form method="post" action="{{ wmEndpoint }}/{{ item.id }}/unhide" style="display:inline">
          <button type="submit" class="button button--small">{{ __("webmention-io.actions.unhide") }}</button>
        </form>
      {% else %}
        <form method="post" action="{{ wmEndpoint }}/{{ item.id }}/hide" style="display:inline">
          <button type="submit" class="button button--small button--secondary">{{ __("webmention-io.actions.hide") }}</button>
        </form>
      {% endif %}

      {% if item.sourceDomain %}
        <form method="post" action="{{ wmEndpoint }}/block" style="display:inline"
              onsubmit="return confirm('Block all webmentions from {{ item.sourceDomain }}?')">
          <input type="hidden" name="domain" value="{{ item.sourceDomain }}">
          <button type="submit" class="button button--small button--secondary">{{ __("webmention-io.actions.block") }} {{ item.sourceDomain }}</button>
        </form>
      {% endif %}
    </div>
  </div>
  {% endfor %}

  {{ pagination(cursor) }}
{%- else -%}
  {{ prose({ text: __("webmention-io.webmentions.none") }) }}
{%- endif %}
{% endblock %}
